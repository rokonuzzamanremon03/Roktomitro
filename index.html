<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>রক্তমিত্র - Roktomitro</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- থিম ভেরিয়েবল (জনতার ইশতেহার স্টাইল) --- */
        :root {
            --primary-red: #D32F2F; /* গাঢ় লাল */
            --accent-red: #FF5252; /* উজ্জ্বল লাল */
            --text-dark: #212121; /* কালো টেক্সট */
            --text-gray: #757575;
            --bg-light: #F4F6F8; /* হালকা ধূসর ব্যাকগ্রাউন্ড */
            --white: #FFFFFF;
            --border-color: #E0E0E0;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
            --header-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* --- গ্লোবাল রিসেট --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Hind Siliguri', sans-serif; }
        body { background-color: var(--bg-light); color: var(--text-dark); line-height: 1.6; }
        
        /* --- ইউটিলিটি ক্লাস --- */
        .container { width: 95%; max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-primary { color: var(--primary-red); }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }

        /* --- বাটন স্টাইল --- */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 10px 20px; border: none; border-radius: 4px; font-weight: 600;
            cursor: pointer; transition: all 0.3s ease; text-decoration: none; font-size: 1rem;
        }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background-color: var(--primary-red); color: var(--white); }
        .btn-outline { background: transparent; border: 2px solid var(--primary-red); color: var(--primary-red); }
        .btn-dark { background-color: var(--text-dark); color: var(--white); }
        .btn-success { background-color: #388E3C; color: white; }
        
        /* --- হেডার / ন্যাভবার --- */
        header { background: var(--white); box-shadow: var(--header-shadow); position: sticky; top: 0; z-index: 1000; padding: 15px 0; }
        .navbar { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 2rem; font-weight: 800; color: var(--primary-red); text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .logo span { color: var(--text-dark); }
        .nav-actions { display: flex; gap: 10px; }

        /* --- হিরো সেকশন --- */
        .hero { 
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1615461168409-64d7bed9637b?q=80&w=1600&auto=format&fit=crop');
            background-size: cover; background-position: center; color: white;
            padding: 80px 0; text-align: center; margin-bottom: 30px;
        }
        .hero h1 { font-size: 3rem; margin-bottom: 15px; font-weight: 700; }
        .hero p { font-size: 1.2rem; margin-bottom: 30px; opacity: 0.9; }

        /* --- কার্ড গ্রিড (ফিচার) --- */
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .feature-card { 
            background: var(--white); padding: 30px; border-radius: 8px; 
            box-shadow: var(--shadow); border-top: 4px solid var(--primary-red);
            text-align: center; transition: transform 0.3s;
        }
        .feature-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .feature-icon { font-size: 3rem; color: var(--primary-red); margin-bottom: 15px; }

        /* --- ফর্ম এবং কন্টেন্ট বক্স (সাদা কার্ড স্টাইল) --- */
        .content-box {
            background: var(--white); padding: 40px; border-radius: 8px;
            box-shadow: var(--shadow); max-width: 800px; margin: 20px auto;
            border: 1px solid var(--border-color);
        }
        .section-header { border-bottom: 2px solid var(--bg-light); padding-bottom: 15px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .section-title { font-size: 1.8rem; color: var(--text-dark); border-left: 5px solid var(--primary-red); padding-left: 15px; }

        /* --- ইনপুট স্টাইল --- */
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-gray); }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px;
            font-size: 1rem; background: #fafafa; transition: border 0.3s;
        }
        .input-group input:focus { border-color: var(--primary-red); outline: none; background: white; }

        /* --- স্টেপ ফর্ম --- */
        .step { display: none; animation: fadeIn 0.4s; }
        .step.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

        /* --- ডোনার কার্ড (রেজাল্ট) --- */
        .donor-card { 
            display: flex; justify-content: space-between; align-items: center;
            background: white; padding: 20px; margin-bottom: 15px; 
            border-left: 5px solid var(--primary-red); border-radius: 4px;
            box-shadow: var(--shadow);
        }
        .blood-badge { background: var(--primary-red); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; }

        /* --- মডাল --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); display: none; 
            justify-content: center; align-items: center; z-index: 5000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 450px;
            text-align: center; position: relative; box-shadow: 0 20px 25px rgba(0,0,0,0.2);
        }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #888; }

        /* --- রেস্পন্সিভ --- */
        @media (max-width: 768px) {
            .navbar { flex-direction: column; gap: 15px; }
            .hero h1 { font-size: 2rem; }
            .donor-card { flex-direction: column; text-align: center; gap: 15px; }
            .nav-actions { flex-wrap: wrap; justify-content: center; }
        }
    </style>
</head>
<body>

    <header>
        <div class="container navbar">
            <a href="#" onclick="showHome()" class="logo"><i class="fa-solid fa-droplet"></i> রক্ত<span>মিত্র</span></a>
            <div class="nav-actions">
                <button class="btn btn-primary" onclick="showView('view-registration')">দাতা হোন</button>
                <button class="btn btn-outline" onclick="showView('view-donation')">ডোনেট করুন (টাকা)</button>
                
                <button id="btn-login-nav" class="btn btn-dark" onclick="openModal('modal-login')">
                    <i class="fa-solid fa-right-to-bracket"></i> লগইন
                </button>
                <button id="btn-profile-nav" class="btn btn-dark hidden" onclick="checkAuth('view-profile')">
                    <i class="fa-solid fa-user"></i> প্রোফাইল
                </button>
            </div>
        </div>
    </header>

    <div id="view-home" class="view-section">
        <section class="hero">
            <div class="container">
                <h1>রক্তে হোক বন্ধুত্ব, বাঁচুক প্রাণ</h1>
                <p>বাংলাদেশের অন্যতম নির্ভরযোগ্য ব্লাড ডোনেশন প্লাটফর্ম</p>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" style="padding: 15px 30px;" onclick="showView('view-registration')">রক্তদাতা হতে চাই</button>
                    <button class="btn btn-white" style="background:white; color:var(--text-dark); padding: 15px 30px;" onclick="checkAuth('view-search')">রক্ত খুঁজছি</button>
                </div>
            </div>
        </section>

        <section class="container">
            <h2 class="text-center mb-20" style="color: var(--text-dark);">আমাদের সেবাসমূহ</h2>
            <div class="feature-grid">
                <div class="feature-card" onclick="checkAuth('view-search')">
                    <div class="feature-icon"><i class="fa-solid fa-magnifying-glass"></i></div>
                    <h3>রক্তদাতা খুঁজুন</h3>
                    <p>লগইন করে আপনার এলাকার ডোনার খুঁজে নিন সহজেই।</p>
                </div>
                <div class="feature-card" onclick="checkAuth('view-blood-request')">
                    <div class="feature-icon"><i class="fa-solid fa-bullhorn"></i></div>
                    <h3>রক্তের আবেদন</h3>
                    <p>জরুরী রক্তের প্রয়োজনে পোস্ট করুন (লগইন প্রয়োজন)।</p>
                </div>
                <div class="feature-card" onclick="showView('view-registration')">
                    <div class="feature-icon"><i class="fa-solid fa-user-plus"></i></div>
                    <h3>রেজিস্ট্রেশন</h3>
                    <p>স্বেচ্ছায় রক্তদাতা হিসেবে আমাদের সাথে যুক্ত হোন।</p>
                </div>
                <div class="feature-card" onclick="showView('view-donation')">
                    <div class="feature-icon"><i class="fa-solid fa-hand-holding-dollar"></i></div>
                    <h3>আর্থিক অনুদান</h3>
                    <p>আমাদের কার্যক্রমে সহায়তা করতে ডোনেট করুন।</p>
                </div>
            </div>
        </section>
    </div>

    <div id="view-registration" class="view-section content-box hidden">
        <div class="section-header">
            <h2 class="section-title">ডোনার রেজিস্ট্রেশন</h2>
            <button class="btn btn-outline" onclick="showHome()">x</button>
        </div>
        
        <form id="donorForm">
            <div class="input-group">
                <label>রক্তের গ্রুপ *</label>
                <select id="bloodGroup" onchange="nextStep('step-name')" required>
                    <option value="" disabled selected>বাছাই করুন</option>
                    <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
                    <option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
                </select>
            </div>

            <div id="step-name" class="step">
                <div class="input-group">
                    <label>পূর্ণ নাম *</label>
                    <input type="text" id="fullName" placeholder="আপনার নাম লিখুন" oninput="checkInput(this, 'step-dob')">
                </div>
            </div>

            <div id="step-dob" class="step">
                <div class="input-group">
                    <label>জন্ম তারিখ *</label>
                    <input type="date" id="dob" onchange="checkAgeLogic()">
                </div>
            </div>

            <div id="step-gender" class="step">
                <div class="input-group">
                    <label>লিঙ্গ *</label>
                    <select id="gender" onchange="nextStep('step-contact')">
                        <option value="">বাছাই করুন</option>
                        <option>Male</option><option>Female</option>
                    </select>
                </div>
            </div>

            <div id="step-contact" class="step">
                <div class="input-group">
                    <label>মোবাইল নম্বর *</label>
                    <input type="tel" id="mobile" placeholder="017xxxxxxxx" oninput="checkMobileGroup()">
                </div>
                <div class="input-group">
                    <label>জেলা ও উপজেলা *</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="district" style="flex:1;">
                            <option value="Satkhira">সাতক্ষীরা</option>
                            <option value="Khulna">খুলনা</option>
                            <option value="Dhaka">ঢাকা</option>
                        </select>
                        <select id="upazila" style="flex:1;">
                            <option value="Kalaroa">কলারোয়া</option>
                            <option value="Tala">তালা</option>
                            <option value="Saddar">সদর</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label>ঠিকানা *</label>
                    <input type="text" id="address" placeholder="গ্রাম/এলাকা..." oninput="nextStep('step-final')">
                </div>
            </div>

            <div id="step-final" class="step">
                <div class="input-group">
                    <label>পাসওয়ার্ড সেট করুন (লগইনের জন্য) *</label>
                    <input type="password" id="regPass" placeholder="গোপন পিন/পাসওয়ার্ড দিন" required>
                </div>
                <div class="input-group">
                    <input type="checkbox" id="agree" required>
                    <label for="agree" style="display:inline;">আমি স্বেচ্ছায় রক্তদানে সম্মত আছি।</label>
                </div>
                <button type="submit" id="submitBtn" class="btn btn-primary" style="width: 100%;">রেজিস্ট্রেশন সম্পন্ন করুন</button>
            </div>
        </form>
    </div>

    <div id="view-search" class="view-section content-box hidden">
        <div class="section-header">
            <h2 class="section-title">রক্তদাতা খুঁজুন</h2>
            <button class="btn btn-outline" onclick="showHome()">হোম</button>
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <select id="searchGroup" class="input-group" style="flex: 1; margin:0;">
                <option value="">গ্রুপ</option>
                <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
                <option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
            </select>
            <select id="searchUpazila" class="input-group" style="flex: 1; margin:0;">
                <option value="">উপজেলা</option>
                <option value="Kalaroa">কলারোয়া</option>
                <option value="Tala">তালা</option>
                <option value="Saddar">সদর</option>
            </select>
            <button class="btn btn-primary" onclick="searchDonors()"><i class="fa-solid fa-search"></i></button>
        </div>
        <div id="searchResults"></div>
    </div>

    <div id="view-blood-request" class="view-section content-box hidden">
        <div class="section-header">
            <h2 class="section-title">রক্তের আবেদন</h2>
            <button class="btn btn-outline" onclick="showHome()">হোম</button>
        </div>
        <form id="requestForm">
            <div class="input-group"><input type="text" id="reqName" placeholder="রোগীর নাম" required></div>
            <div class="input-group">
                <select id="reqGroup" required>
                     <option value="">প্রয়োজনীয় গ্রুপ</option>
                     <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
                     <option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
                </select>
            </div>
            <div class="input-group"><input type="tel" id="reqMobile" placeholder="যোগাযোগ নম্বর" required></div>
            <div class="input-group"><input type="text" id="reqLocation" placeholder="হাসপাতাল/স্থান" required></div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">পোস্ট করুন</button>
        </form>
        <div id="requestList" class="mt-20"></div>
    </div>

    <div id="view-donation" class="view-section content-box hidden">
        <div class="section-header">
            <h2 class="section-title">আর্থিক অনুদান</h2>
            <button class="btn btn-outline" onclick="showHome()">হোম</button>
        </div>
        <p class="mb-20">আপনার ক্ষুদ্র অনুদান রক্তমিত্রের কার্যক্রমকে এগিয়ে নিতে সাহায্য করবে।</p>
        <div class="input-group"><input type="text" id="cus_name" placeholder="আপনার নাম" value="Guest"></div>
        <div class="input-group"><input type="tel" id="mobile_don" placeholder="আপনার নম্বর"></div>
        <div class="input-group"><input type="number" id="amount" placeholder="টাকার পরিমাণ (মিন ১০ টাকা)" value="50"></div>
        <button id="payBtn" class="btn btn-success" style="width: 100%;" onclick="processPayment()">
            ZiniPay এর মাধ্যমে পেমেন্ট করুন
        </button>
        <div id="status-msg" class="text-center mt-20"></div>
    </div>

    <div id="view-profile" class="view-section content-box hidden">
        <div class="section-header">
            <h2 class="section-title">আমার প্রোফাইল</h2>
            <button class="btn btn-primary" onclick="handleLogout()">লগ আউট</button>
        </div>
        <div class="text-center">
            <h3 id="pName" class="text-primary"></h3>
            <p>ID: <span id="pId"></span></p>
            <div class="blood-badge" id="pGroup" style="margin: 20px auto;"></div>
            <hr>
            <div class="input-group mt-20">
                <label>শেষ রক্তদানের তারিখ আপডেট করুন:</label>
                <input type="date" id="pLastDonation">
            </div>
            <button class="btn btn-dark" onclick="updateDonationDate()">আপডেট</button>
        </div>
    </div>

    <div id="modal-login" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('modal-login')">&times;</span>
            <h3 class="mb-20" style="color: var(--primary-red);">লগইন</h3>
            <p class="mb-20" style="font-size: 0.9rem; color: #666;">সার্চ এবং অন্যান্য ফিচারের জন্য লগইন করুন</p>
            <input type="text" id="lId" placeholder="Donor ID (RM-XXXX)" class="input-group" style="width: 100%; padding: 10px; margin-bottom: 10px;">
            <input type="password" id="lPass" placeholder="Password" class="input-group" style="width: 100%; padding: 10px; margin-bottom: 10px;">
            <button class="btn btn-primary" style="width: 100%;" onclick="handleLogin()">প্রবেশ করুন</button>
            <p style="margin-top: 15px; font-size: 0.9rem;">একাউন্ট নেই? <a href="#" onclick="closeModal('modal-login'); showView('view-registration')" style="color: var(--primary-red);">রেজিস্ট্রেশন করুন</a></p>
        </div>
    </div>

    <div id="modal-success" class="modal-overlay">
        <div class="modal-content">
            <i class="fa-solid fa-circle-check" style="font-size: 4rem; color: green; margin-bottom: 15px;"></i>
            <h3>অভিনন্দন!</h3>
            <p>আপনার ডোনার আইডি:</p>
            <h2 id="success-id" style="color: var(--primary-red); margin: 10px 0;"></h2>
            <p style="color: red; font-size: 0.8rem;">(আইডিটি মনে রাখুন, লগইনের জন্য প্রয়োজন হবে)</p>
            <button class="btn btn-primary mt-20" onclick="closeModal('modal-success'); showHome()">ঠিক আছে</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // ফায়ারবেস কনফিগারেশন (আপনার দেওয়া)
        const firebaseConfig = {
          apiKey: "AIzaSyAhiWE13tazdBO8uKdFAK7obuMrHRyK4PE",
          authDomain: "roktomitro-6e5d3.firebaseapp.com",
          projectId: "roktomitro-6e5d3",
          storageBucket: "roktomitro-6e5d3.firebasestorage.app",
          messagingSenderId: "1089255935970",
          appId: "1:1089255935970:web:ceb2feaab1b5096878f3bb",
          measurementId: "G-7TX43Q5C3K"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // গ্লোবাল ভেরিয়েবল
        let currentUser = null; // লগইন স্ট্যাটাস ট্র্যাক করার জন্য

        // --- ভিউ ম্যানেজমেন্ট এবং অথেনটিকেশন লজিক ---
        
        window.showView = function(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            window.scrollTo(0,0);
            
            // স্পেশাল লোড
            if(viewId === 'view-blood-request') loadRequests();
        };

        window.showHome = function() { showView('view-home'); };
        window.openModal = function(id) { document.getElementById(id).style.display = 'flex'; };
        window.closeModal = function(id) { document.getElementById(id).style.display = 'none'; };

        // **গুরুত্বপূর্ণ: অথেনটিকেশন চেক (লগইন ছাড়া ঢুকতে দেবে না)**
        window.checkAuth = function(targetView) {
            if (currentUser) {
                showView(targetView);
            } else {
                alert("এই সুবিধাটি পেতে অনুগ্রহ করে লগইন করুন।");
                openModal('modal-login');
            }
        };

        // --- লগইন এবং লগআউট ---

        window.handleLogin = async function() {
            const id = document.getElementById('lId').value.trim();
            const pass = document.getElementById('lPass').value.trim();
            const btn = document.querySelector('#modal-login .btn');
            
            if(!id || !pass) return alert("আইডি এবং পাসওয়ার্ড দিন");
            
            btn.innerText = "যাচাই করা হচ্ছে...";
            
            try {
                const docSnap = await getDoc(doc(db, "donors", id));
                if (docSnap.exists() && docSnap.data().password === pass) {
                    currentUser = docSnap.data();
                    currentUser.id = id;
                    
                    // UI আপডেট
                    closeModal('modal-login');
                    document.getElementById('btn-login-nav').classList.add('hidden');
                    document.getElementById('btn-profile-nav').classList.remove('hidden');
                    
                    alert("স্বাগতম, " + currentUser.fullName);
                    loadProfileData();
                    showView('view-home'); 
                } else {
                    alert("ভুল আইডি বা পাসওয়ার্ড!");
                }
            } catch(e) { console.error(e); alert("নেটওয়ার্ক সমস্যা!"); }
            btn.innerText = "প্রবেশ করুন";
        };

        window.handleLogout = function() {
            currentUser = null;
            document.getElementById('btn-login-nav').classList.remove('hidden');
            document.getElementById('btn-profile-nav').classList.add('hidden');
            showHome();
            alert("লগআউট সফল।");
        };

        // --- রেজিস্ট্রেশন লজিক ---

        // ফর্ম স্টেপ কন্ট্রোল
        window.nextStep = function(stepId) {
            document.getElementById(stepId).classList.add('active');
            setTimeout(() => document.getElementById(stepId).scrollIntoView({behavior: 'smooth', block: 'center'}), 100);
        };
        window.checkInput = function(el, next) { if(el.value.length > 2) nextStep(next); };
        window.checkAgeLogic = function() {
            const age = new Date().getFullYear() - new Date(document.getElementById('dob').value).getFullYear();
            if(age < 18) { alert("১৮ বছরের নিচে রক্তদান সম্ভব নয়।"); document.getElementById('dob').value=""; }
            else nextStep('step-gender');
        };
        window.checkMobileGroup = function() { 
            if(document.getElementById('mobile').value.length >= 11) nextStep('step-contact'); 
        };

        // সাবমিট
        document.getElementById('donorForm').addEventListener('submit', async function(e){
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerText = "অপেক্ষা করুন..."; btn.disabled = true;

            const donorId = "RM-" + Math.floor(1000 + Math.random() * 9000);
            
            const data = {
                fullName: document.getElementById('fullName').value,
                bloodGroup: document.getElementById('bloodGroup').value,
                mobile: document.getElementById('mobile').value,
                district: document.getElementById('district').value,
                upazila: document.getElementById('upazila').value,
                address: document.getElementById('address').value,
                password: document.getElementById('regPass').value, // সরাসরি পাসওয়ার্ড সেট হচ্ছে
                dob: document.getElementById('dob').value,
                gender: document.getElementById('gender').value,
                lastDonation: "N/A",
                isActive: true
            };

            try {
                await setDoc(doc(db, "donors", donorId), data);
                document.getElementById('success-id').innerText = donorId;
                openModal('modal-success');
                document.getElementById('donorForm').reset();
            } catch(error) {
                alert("সমস্যা হয়েছে! ইন্টারনেট চেক করুন।");
            }
            btn.innerText = "রেজিস্ট্রেশন সম্পন্ন করুন"; btn.disabled = false;
        });

        // --- সার্চ লজিক (Private) ---
        window.searchDonors = async function() {
            // এই ফাংশনটি কল করার আগেই checkAuth কল করা হয়েছে, তাই এখানে currentUser থাকবে
            const group = document.getElementById('searchGroup').value;
            const upazila = document.getElementById('searchUpazila').value;
            const resDiv = document.getElementById('searchResults');
            
            resDiv.innerHTML = '<p class="text-center">খুঁজছি...</p>';
            
            const snapshot = await getDocs(collection(db, "donors"));
            let html = "";
            let count = 0;

            snapshot.forEach(doc => {
                const d = doc.data();
                if ((group==="" || d.bloodGroup===group) && (upazila==="" || d.upazila===upazila)) {
                    count++;
                    html += `
                        <div class="donor-card">
                            <div style="display:flex; align-items:center; gap:15px;">
                                <div class="blood-badge">${d.bloodGroup}</div>
                                <div>
                                    <h4>${d.fullName}</h4>
                                    <small><i class="fa-solid fa-location-dot"></i> ${d.upazila}, ${d.address}</small>
                                </div>
                            </div>
                            <a href="tel:${d.mobile}" class="btn btn-success"><i class="fa-solid fa-phone"></i> কল করুন</a>
                        </div>
                    `;
                }
            });
            resDiv.innerHTML = count > 0 ? html : '<p class="text-center text-primary">কোনো ডোনার পাওয়া যায়নি</p>';
        };

        // --- প্রোফাইল এবং অন্যান্য ---
        function loadProfileData() {
            document.getElementById('pName').innerText = currentUser.fullName;
            document.getElementById('pId').innerText = currentUser.id;
            document.getElementById('pGroup').innerText = currentUser.bloodGroup;
            if(currentUser.lastDonation !== "N/A") document.getElementById('pLastDonation').value = currentUser.lastDonation;
        }

        window.updateDonationDate = async function() {
            const date = document.getElementById('pLastDonation').value;
            if(date) {
                await updateDoc(doc(db, "donors", currentUser.id), { lastDonation: date });
                alert("আপডেট সফল!");
                currentUser.lastDonation = date; // লোকাল আপডেট
            }
        };

        // ব্লাড রিকোয়েস্ট লোড
        async function loadRequests() {
            const snaps = await getDocs(collection(db, "blood_requests"));
            let html = "";
            snaps.forEach(doc => {
                const d = doc.data();
                html += `
                <div style="background:#fff5f5; padding:15px; border-radius:5px; margin-bottom:10px; border-left:3px solid red;">
                    <h4>${d.group} প্রয়োজন</h4>
                    <p>রোগী: ${d.name} | স্থান: ${d.location}</p>
                    <a href="tel:${d.mobile}" style="color:red; font-weight:bold;">কল করুন: ${d.mobile}</a>
                </div>`;
            });
            document.getElementById('requestList').innerHTML = html || "<p>কোনো রিকোয়েস্ট নেই</p>";
        }

        document.getElementById('requestForm').addEventListener('submit', async function(e){
            e.preventDefault();
            const data = {
                name: document.getElementById('reqName').value,
                group: document.getElementById('reqGroup').value,
                mobile: document.getElementById('reqMobile').value,
                location: document.getElementById('reqLocation').value,
                time: new Date()
            };
            await addDoc(collection(db, "blood_requests"), data);
            alert("পোস্ট করা হয়েছে!");
            document.getElementById('requestForm').reset();
            loadRequests();
        });
    </script>

    <script>
        const API_KEY = "d539cd6c2549fd30e0ed87eae12ebe58fde3b9fc1bb8fc90"; 
        const CREATE_URL = "https://api.zinipay.com/v1/payment/create";
        const BRAND_DOMAIN = "https://roktomitro.netlify.app"; // আপনার লাইভ লিংক

        async function processPayment() {
            const amount = document.getElementById('amount').value;
            const mobile = document.getElementById('mobile_don').value;
            const name = document.getElementById('cus_name').value;
            const btn = document.getElementById('payBtn');
            const msg = document.getElementById('status-msg');

            if(amount < 10) { msg.innerHTML = "<span style='color:red'>মিনিমাম ১০ টাকা।</span>"; return; }
            
            btn.innerText = "প্রসেসিং..."; btn.disabled = true;

            const payload = {
                "cus_name": name,
                "cus_email": "donor@roktomitro.com",
                "amount": amount,
                "redirect_url": `${BRAND_DOMAIN}?status=success`,
                "cancel_url": `${BRAND_DOMAIN}?status=cancel`,
                "metadata": { "phone": mobile }
            };

            try {
                const response = await fetch(CREATE_URL, {
                    method: "POST",
                    headers: { "zini-api-key": API_KEY, "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (data.payment_url) window.location.href = data.payment_url;
                else msg.innerHTML = "সমস্যা হয়েছে।";
            } catch (error) {
                msg.innerHTML = "নেটওয়ার্ক এরর।";
            }
            btn.innerText = "পেমেন্ট করুন"; btn.disabled = false;
        }

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('status') === 'success') {
                alert("ধন্যবাদ! আপনার ডোনেশন সফল হয়েছে।");
                window.location.href = "/";
            }
        };
    </script>
</body>
</html>
