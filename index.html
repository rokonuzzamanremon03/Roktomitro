<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>রক্তমিত্র - Roktomitro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #764ba2;
            --secondary-color: #667eea;
            --accent-color: #ff4b2b;
            --success-color: #28a745;
            --warning-color: #ffcc00;
            --text-dark: #333;
            --text-light: #f4f6f9;
            --gradient-bg: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Hind Siliguri', sans-serif; }
        body { background: var(--gradient-bg); min-height: 100vh; color: var(--text-dark); overflow-x: hidden; }
        a { text-decoration: none; }

        .container { width: 95%; max-width: 1100px; margin: 0 auto; padding: 20px; }
        .btn {
            display: inline-flex; align-items: center; gap: 8px; padding: 12px 25px;
            border: none; border-radius: 50px; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease; font-size: 1rem; color: white;
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-primary { background: linear-gradient(90deg, #ff416c 0%, var(--accent-color) 100%); box-shadow: 0 4px 15px rgba(255, 75, 43, 0.3); }
        .btn-success { background: linear-gradient(90deg, #11998e 0%, var(--success-color) 100%); }
        .btn-info { background: linear-gradient(90deg, #36D1DC 0%, #5B86E5 100%); }
        .btn-secondary { background: #6c757d; }
        .text-accent { color: var(--accent-color); }
        .text-success { color: var(--success-color); }
        .text-center { text-align: center; }
        .mb-20 { margin-bottom: 20px; }

        #toast-box {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(40, 167, 69, 0.95); color: white;
            padding: 15px 30px; border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: none; align-items: center; gap: 15px; z-index: 10000; font-size: 1rem;
            animation: slideDown 0.5s forwards;
        }
        @keyframes slideDown { from{top: -100px; opacity: 0;} to{top: 30px; opacity: 1;} }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px);
            display: none; justify-content: center; align-items: center; z-index: 5000;
            padding: 20px;
        }
        .modal-content {
            background: #fff; color: var(--text-dark); padding: 40px; border-radius: 25px;
            width: 100%; max-width: 550px; max-height: 90vh; overflow-y: auto;
            position: relative; animation: zoomIn 0.4s ease-out; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }
        @keyframes zoomIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        .modal-close-btn {
            position: absolute; top: 20px; right: 25px; font-size: 2rem; color: #999;
            cursor: pointer; transition: 0.2s; line-height: 1;
        }
        .modal-close-btn:hover { color: var(--accent-color); transform: rotate(90deg); }
        .modal-header { font-size: 1.8rem; font-weight: 700; margin-bottom: 25px; color: var(--primary-color); text-align: center; }
        .modal-body { font-size: 1.1rem; line-height: 1.7; color: #555; }

        #popup-maintenance .modal-content { border-top: 8px solid var(--warning-color); text-align: center; }
        #popup-maintenance .warn-icon { font-size: 4rem; color: var(--warning-color); margin-bottom: 20px; animation: pulse 2s infinite; }

        .styled-list p { margin-bottom: 15px; position: relative; padding-left: 35px; }
        .styled-list p::before {
            content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            position: absolute; left: 0; top: 2px; color: var(--success-color); font-size: 1.2rem;
        }
        #modal-agreement .modal-content, #modal-policy .modal-content { border-left: 8px solid var(--secondary-color); }

        #modal-underage .modal-content { border-top: 8px solid var(--warning-color); text-align: center; }
        #modal-underage .sad-icon { font-size: 5rem; color: var(--warning-color); margin-bottom: 25px; }

        .info-list-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #f4f6f9; padding: 15px 20px; border-radius: 12px; margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        .info-label { font-weight: 700; color: var(--primary-color); display: flex; align-items: center; gap: 10px; }
        .info-value { font-family: monospace; font-size: 1.1rem; color: #333; display: flex; align-items: center; gap: 10px; }
        .copy-btn {
            background: rgba(var(--secondary-color), 0.1); color: var(--secondary-color);
            padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: 0.2s;
        }
        .copy-btn:hover { background: var(--secondary-color); color: white; }

        #view-home { color: white; padding-top: 40px; animation: fadeIn 0.8s; }
        .home-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .logo-text { font-size: 2.5rem; font-weight: 800; }
        .hero-section { text-align: center; margin-bottom: 60px; }
        .hero-title { font-size: 3.5rem; font-weight: 800; margin-bottom: 20px; text-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .hero-buttons { display: flex; flex-direction: column; gap: 20px; align-items: center; margin-top: 40px; }
        .btn-large { padding: 15px 40px; font-size: 1.3rem; width: 100%; max-width: 400px; justify-content: center; }

        .article-section { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 50px; border-radius: 30px; margin-top: 60px; }
        .article-title { font-size: 2.5rem; font-weight: 700; margin-bottom: 30px; text-align: center; color: var(--warning-color); }
        .article-content p { font-size: 1.15rem; line-height: 1.8; margin-bottom: 25px; opacity: 0.9; text-align: justify; }

        #view-registration {
            display: none; background: var(--glass-bg); backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); border-radius: 30px;
            padding: 40px; width: 100%; max-width: 700px; margin: 40px auto; color: white;
            max-height: 90vh; overflow-y: auto; animation: fadeIn 0.5s;
        }
        .form-header { text-align: center; margin-bottom: 40px; }
        .form-header h2 { font-size: 2.2rem; margin-bottom: 10px; }
        .input-group { margin-bottom: 25px; }
        .input-group label { display: block; margin-bottom: 10px; font-weight: 600; font-size: 1.05rem; }
        .input-group input, .input-group select {
            width: 100%; padding: 15px; background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3); border-radius: 12px;
            color: white; font-size: 1rem; outline: none; transition: 0.3s;
        }
        .input-group input:focus, .input-group select:focus { background: rgba(255,255,255,0.3); border-color: white; }
        .input-group option { background: #333; color: white; }
        .step { display: none; animation: slideUp 0.5s ease-out; }
        .step.active { display: block; }
        @keyframes slideUp { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }
        .checkbox-wrapper {
            display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.15);
            padding: 15px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.3);
        }
        .checkbox-wrapper input { width: 20px; height: 20px; accent-color: var(--accent-color); }
        
        .clickable-text { color: var(--warning-color); font-weight: bold; text-decoration: underline; }

        @media (max-width: 768px) {
            .home-header { flex-direction: column; gap: 20px; }
            .hero-title { font-size: 2.5rem; }
            .btn-large { font-size: 1.1rem; padding: 12px 30px; }
            .article-section { padding: 30px; }
            .modal-content { padding: 25px; }
        }
    </style>
</head>
<body>

    <div id="toast-box"></div>

    <div id="popup-maintenance" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <span class="modal-close-btn" onclick="closeModal('popup-maintenance')">&times;</span>
            <i class="fa-solid fa-triangle-exclamation warn-icon"></i>
            <div class="modal-header">আপডেট চলছে</div>
            <div class="modal-body">
                <p>প্রিয় ভিজিটর, আমাদের ওয়েবসাইটটি এখন আরও উন্নত <strong>Firebase</strong> সার্ভারে আপডেট করা হচ্ছে।</p>
                <p>এখন রেজিস্ট্রেশন করলে আপনার তথ্য সরাসরি আমাদের নতুন ডাটাবেসে যুক্ত হবে।</p>
            </div>
            <div class="text-center" style="margin-top: 30px;">
                <button class="btn btn-primary btn-large" style="width: 100%; justify-content: center;" onclick="handlePopupRegistration()">
                    <i class="fa-solid fa-user-plus"></i> ডোনার রেজিস্ট্রেশন করুন
                </button>          
                <p style="margin-top: 10px; font-size: 0.9rem; color: #777;">(এই পপ-আপটি <span id="timer">10</span> সেকেন্ড পর বন্ধ হবে)</p>
            </div>
        </div>
    </div>

    <div id="modal-fb-warning" class="modal-overlay" style="z-index: 9999;">
        <div class="modal-content" style="text-align: center; border-top: 8px solid #1877f2;">
            <div style="font-size: 4rem; color: #1877f2; margin-bottom: 20px;">
                <i class="fa-brands fa-facebook"></i>
            </div>
            <h3 style="color: #333; font-weight: 700;">ব্রাউজার পরিবর্তন করুন</h3>
            <p style="font-size: 1.1rem; color: #555; margin: 20px 0; line-height: 1.6;">
                আপনি বর্তমানে <strong>Facebook/Messenger</strong> এর ইন-অ্যাপ ব্রাউজার ব্যবহার করছেন। ওয়েবসাইটটি সঠিকভাবে ব্যবহার করতে দয়া করে এটি <strong>Google Chrome</strong> এ ওপেন করুন।
            </p>
            <button class="btn btn-primary" style="width: 100%; justify-content: center; background: #1877f2; font-size: 1.1rem; padding: 15px;" onclick="openInChrome()">
                <i class="fa-brands fa-chrome"></i> Open in Chrome
            </button>
        </div>
    </div>

    <div class="container">
        <div id="view-home">
            <header class="home-header">
                <div class="logo-text"><span class="text-accent">রক্ত</span>মিত্র</div>
                <button class="btn btn-success" onclick="openModal('modal-donation-details')">
                    <i class="fa-solid fa-hand-holding-dollar"></i> ডোনেশন করুন
                </button>
            </header>

            <section class="hero-section">
                <h1 class="hero-title">আপনার রক্তে বাঁচুক একটি প্রাণ</h1>
                <p style="font-size: 1.2rem; opacity: 0.9;">রক্তদান একটি মহৎ কাজ। আসুন, আমরা সবাই মিলে একটি সুস্থ সমাজ গড়ে তুলি।</p>

                <div class="hero-buttons">
                    <button class="btn btn-primary btn-large" style="font-size: 1.5rem; padding: 20px 50px;" onclick="showRegistration()">
                        <i class="fa-solid fa-user-plus"></i> ডোনার হোন (Registration)
                    </button>
                    <button class="btn btn-info btn-large" onclick="openModal('modal-contact')">
                        <i class="fa-solid fa-magnifying-glass"></i> রক্ত খুঁজুন (Blood Search)
                    </button>
                </div>
            </section>
            
            <section class="article-section">
                <h2 class="article-title"><i class="fa-solid fa-quote-left"></i> রক্তমিত্র ও মানবতার ডাক <i class="fa-solid fa-quote-right"></i></h2>
                <div class="article-content">
                    <p><strong>"রক্তমিত্র"</strong> এখন আরও শক্তিশালী। আমাদের নতুন প্রযুক্তির মাধ্যমে আমরা আরও দ্রুত রক্তদাতা খুঁজে বের করতে সক্ষম।</p>
                    <p>রক্তদান একটি অত্যন্ত সহজ ও নিরাপদ প্রক্রিয়া। একজন সুস্থ প্রাপ্তবয়স্ক মানুষ প্রতি ৩-৪ মাস অন্তর রক্তদান করতে পারেন। এতে শরীরের কোনো ক্ষতি হয় না, বরং নতুন রক্তকণিকা তৈরির প্রক্রিয়া ত্বরান্বিত হয়।</p>
                </div>
            </section>
        </div>

        <div id="view-registration">
            <button class="btn btn-secondary mb-20" onclick="showHome()"><i class="fa-solid fa-arrow-left"></i> হোম পেজে ফিরে যান</button>
            <div class="form-header">
                <h2>ডোনার রেজিস্ট্রেশন</h2>
                <p>সঠিক তথ্য দিয়ে ফর্মটি পূরণ করুন এবং জীবন বাঁচাতে এগিয়ে আসুন</p>
            </div>

            <form id="donorForm">
                <div class="input-group">
                    <label><i class="fa-solid fa-droplet text-accent"></i> রক্তের গ্রুপ *</label>
                    <select id="bloodGroup" onchange="nextStep('step-name')">
                        <option value="" disabled selected>বাছাই করুন</option>
                        <option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
                    </select>
                </div>
                <div id="step-name" class="step input-group">
                    <label><i class="fa-solid fa-user text-accent"></i> পূর্ণ নাম *</label>
                    <input type="text" id="fullName" placeholder="আপনার নাম লিখুন" oninput="checkInput(this, 'step-dob')">
                </div>
                <div id="step-dob" class="step input-group">
                    <label><i class="fa-solid fa-calendar-days text-accent"></i> জন্ম তারিখ *</label>
                    <input type="date" id="dob" onchange="checkAgeLogic()">
                </div>
                <div id="step-gender" class="step input-group">
                    <label><i class="fa-solid fa-venus-mars text-accent"></i> লিঙ্গ *</label>
                    <select id="gender" onchange="nextStep('step-mobile')">
                        <option value="" disabled selected>বাছাই করুন</option>
                        <option>পুরুষ</option><option>মহিলা</option><option>অন্যান্য</option>
                    </select>
                </div>
                <div id="step-mobile" class="step">
                    <div class="input-group">
                        <label><i class="fa-solid fa-phone text-accent"></i> মোবাইল নম্বর *</label>
                        <input type="tel" id="mobile" placeholder="017xxxxxxxx" oninput="checkMobileGroup()">
                    </div>
                    <div class="input-group">
                        <label><i class="fa-solid fa-mobile-screen text-accent"></i> বিকল্প মোবাইল নম্বর</label>
                        <input type="tel" id="altMobile" placeholder="01xxxxxxxxx" oninput="updateWhatsappList()">
                    </div>
                </div>
                <div id="step-address" class="step">
                    <div class="input-group">
                        <label><i class="fa-solid fa-map-location-dot text-accent"></i> জেলা *</label>
                        <select id="district" onchange="checkAddressGroup()">
                            <option value="" disabled selected>বাছাই করুন</option>
                            <option>সাতক্ষীরা</option><option>খুলনা</option><option>ঢাকা</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label><i class="fa-solid fa-map-pin text-accent"></i> উপজেলা *</label>
                        <select id="upazila" onchange="checkAddressGroup()">
                            <option value="" disabled selected>বাছাই করুন</option>
                            <option>কলারোয়া</option><option>তালা</option><option>সদর</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label><i class="fa-solid fa-house-chimney text-accent"></i> বিস্তারিত ঠিকানা *</label>
                        <input type="text" id="address" placeholder="গ্রাম/রোড নং/বাড়ি নং..." oninput="checkAddressGroup()">
                    </div>
                </div>
                <div id="step-donation" class="step">
                    <div class="input-group">
                        <label><i class="fa-solid fa-calendar-check text-accent"></i> শেষ রক্তদানের তারিখ</label>
                        <input type="date" id="lastDonation" onchange="checkDonationDate()">
                    </div>
                    <div class="checkbox-wrapper mb-20">
                        <input type="checkbox" id="activeDonor" checked>
                        <label for="activeDonor" style="cursor:pointer; margin:0">আপনি কি নিয়মিত রক্ত দানে ইচ্ছুক?</label>
                    </div>
                    <div class="input-group">
                        <label><i class="fa-solid fa-clock-rotate-left text-accent"></i> কত মাস পর পর রক্ত দিতে পারবেন?</label>
                        <select id="frequency" onchange="nextStep('step-social')">
                            <option value="4" selected>৪ মাস (স্ট্যান্ডার্ড)</option>
                            <option value="3">৩ মাস</option><option value="6">৬ মাস</option>
                        </select>
                    </div>
                    <p class="text-accent" style="text-align:right; font-size:0.9rem; cursor:pointer;" onclick="nextStep('step-social')">পরবর্তী ধাপ &rarr;</p>
                </div>
                <div id="step-social" class="step">
                    <div class="input-group">
                        <label><i class="fa-brands fa-whatsapp text-accent"></i> হোয়াটসঅ্যাপ নম্বর</label>
                        <select id="whatsappSelect" onchange="handleWhatsappLogic()">
                            <option value="">বাছাই করুন (ঐচ্ছিক)</option>
                        </select>
                        <input type="tel" id="whatsappCustom" placeholder="নম্বর লিখুন" style="display:none; margin-top:10px;">
                    </div>
                    <div class="input-group">
                        <label><i class="fa-brands fa-facebook text-accent"></i> ফেসবুক প্রোফাইল লিংক</label>
                        <input type="url" id="fbLink" placeholder="https://facebook.com/user">
                    </div>
                    <p class="text-accent" style="text-align:right; font-size:0.9rem; cursor:pointer;" onclick="nextStep('step-agreement')">স্কিপ করুন &rarr;</p>
                </div>
                <div id="step-agreement" class="step">
                    <div class="checkbox-wrapper" style="background: rgba(255, 75, 43, 0.2); border: 2px solid var(--accent-color);">
                        <input type="checkbox" id="agreePolicy" onchange="toggleSubmit()">
                        <label for="agreePolicy" style="cursor:pointer; margin:0; font-size: 1rem;">
                            আমি <span class="clickable-text" onclick="openModal('modal-agreement')">শর্তাবলী</span> এবং <span class="clickable-text" onclick="openModal('modal-policy')">পলিসি</span> পড়েছি এবং মেনে নিচ্ছি।
                        </label>
                    </div>
                    <button type="button" id="submitBtn" class="btn btn-primary" style="width:100%; margin-top:25px; padding: 15px; font-size: 1.2rem; display:none;">
                        রেজিস্ট্রেশন সম্পন্ন করুন <i class="fa-solid fa-check-circle"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-donation-details" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn" onclick="closeModal('modal-donation-details')">&times;</span>
            <div class="modal-header"><i class="fa-solid fa-hand-holding-dollar text-success"></i> ডোনেশন ডিটেইলস</div>
            <div class="modal-body">
                <p class="text-center mb-20">আপনার সামান্য অনুদান আমাদের কার্যক্রমকে এগিয়ে নিতে সাহায্য করবে।</p>
                <div class="info-list-item">
                    <div class="info-label">বিকাশ (Personal)</div>
                    <div class="info-value"><span id="bkash-num">Coming Soon</span> <i class="fa-regular fa-copy copy-btn" onclick="copyText('bkash-num')"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-contact" class="modal-overlay">
        <div class="modal-content">
             <span class="modal-close-btn" onclick="closeModal('modal-contact')">&times;</span>
            <div class="modal-header">রক্ত খুঁজুন</div>
            <div class="modal-body text-center">
                <p class="mb-20">অটোমেটিক সার্চ সিস্টেমটি শীঘ্রই চালু হচ্ছে। বর্তমানে জরুরি প্রয়োজনে কল করুন:</p>
                <a href="tel:+8801338891213" class="btn btn-success"><i class="fa-solid fa-phone"></i> 01338-891213</a>
            </div>
        </div>
    </div>

    <div id="modal-agreement" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn" onclick="closeModal('modal-agreement')">&times;</span>
            <div class="modal-header">শর্তাবলী</div>
            <div class="modal-body styled-list">
                <p>আমি স্বেচ্ছায় রক্তদান করছি।</p>
                <p>আমার দেওয়া তথ্য সম্পূর্ণ সঠিক।</p>
            </div>
        </div>
    </div>

    <div id="modal-policy" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn" onclick="closeModal('modal-policy')">&times;</span>
            <div class="modal-header">প্রাইভেসি পলিসি</div>
            <div class="modal-body styled-list">
                <p>আপনার তথ্য নিরাপদ থাকবে।</p>
                <p>শুধুমাত্র জরুরি প্রয়োজনে ব্যবহার করা হবে।</p>
            </div>
        </div>
    </div>

    <div id="modal-underage" class="modal-overlay">
        <div class="modal-content" style="border-top: 8px solid var(--warning-color); text-align: center;">
            <span class="modal-close-btn" onclick="closeModal('modal-underage')">&times;</span>
            <i class="fa-regular fa-face-sad-tear sad-icon"></i>
            <div class="modal-header text-accent">বয়স ১৮ হয়নি!</div>
            <div class="modal-body">
                <p>দুঃখিত, ১৮ বছরের নিচে রক্তদান করা সম্ভব নয়।</p>
                <button class="btn btn-warning" style="margin-top: 25px;" onclick="closeModal('modal-underage')">ঠিক আছে</button>
            </div>
        </div>
    </div>

    <div id="view-already-registered" style="display: none; width: 95%; max-width: 500px; margin: 50px auto; text-align: center; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.1);">
        <div style="font-size: 4rem; color: var(--success-color); margin-bottom: 20px;"><i class="fa-solid fa-circle-check"></i></div>
        <h2 style="color: var(--primary-color);">স্বাগতম রক্তযোদ্ধা!</h2>
        <div style="background: #f4f6f9; padding: 20px; border-radius: 15px; text-align: left; margin: 30px 0; border-left: 5px solid var(--accent-color);">
            <p><strong>নাম:</strong> <span id="reg-name">--</span></p>
            <p><strong>আইডি:</strong> <span id="reg-id" style="color: var(--success-color); font-weight: bold;">--</span></p>
            <p><strong>রক্তের গ্রুপ:</strong> <span id="reg-group" style="color: var(--accent-color); font-weight: bold;">--</span></p>
        </div>
        <button class="btn btn-secondary" onclick="showRegistrationForm(true)">অন্যের জন্য রেজিস্ট্রেশন</button>
        <br><br>
        <button class="btn btn-primary" onclick="showHome()">হোম পেজে যান</button>
    </div>

    <div id="modal-success" class="modal-overlay">
        <div class="modal-content" style="text-align: center; border-top: 8px solid var(--success-color);">
            <div style="font-size: 5rem; color: var(--success-color); margin-bottom: 20px;"><i class="fa-solid fa-heart-circle-check"></i></div>
            <h2 class="text-success" style="font-weight: 800;">অভিনন্দন!</h2>
            <p>রেজিস্ট্রেশন সফল হয়েছে।</p>
            <div style="background: #f1f8e9; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px dashed #28a745;">
                <p>আপনার ডোনার আইডি</p>
                <h1 id="success-id" style="font-size: 3rem; color: var(--primary-color); margin: 10px 0;">RM-XXXX</h1>
            </div>
            <button class="btn btn-primary" onclick="location.reload()">ঠিক আছে</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase Functions from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBfF676e-fHzem6zH00ySGA7MByqlRrkok",
            authDomain: "roktomitro-2026.firebaseapp.com",
            projectId: "roktomitro-2026",
            storageBucket: "roktomitro-2026.firebasestorage.app",
            messagingSenderId: "893853042616",
            appId: "1:893853042616:web:4cd35cb914791f58b6314d",
            measurementId: "G-RQV8C0C8QS"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Global Functions (Attached to Window for HTML access) ---
        window.openModal = function(id) {
            const m = document.getElementById(id);
            if(m) m.style.display = 'flex';
        }
        window.closeModal = function(id) {
            const m = document.getElementById(id);
            if(m) m.style.display = 'none';
            if(id === 'modal-underage') document.getElementById('dob').value = '';
        }
        window.openInChrome = function() {
            var url = window.location.href;
            var intentUrl = "intent://" + url.replace("https://", "").replace("http://", "") + "#Intent;scheme=https;package=com.android.chrome;end";
            window.location.href = intentUrl;
        }
        window.closePopupForever = function() {
            document.getElementById('popup-maintenance').style.display = 'none';
            localStorage.setItem('roktomitro_popup_seen', 'true');
        }
        window.handlePopupRegistration = function() {
            window.closePopupForever();
            window.showRegistration();
        }
        window.showRegistration = function() {
            const savedUser = localStorage.getItem('roktomitro_donor');
            document.getElementById('view-home').style.display = 'none';
            if (savedUser) {
                document.getElementById('view-already-registered').style.display = 'block';
                document.getElementById('view-registration').style.display = 'none';
            } else {
                document.getElementById('view-already-registered').style.display = 'none';
                document.getElementById('view-registration').style.display = 'block';
            }
            window.scrollTo(0, 0);
        }
        window.showRegistrationForm = function(forceShow = false) {
            document.getElementById('view-already-registered').style.display = 'none';
            document.getElementById('view-registration').style.display = 'block';
            if(forceShow) document.getElementById('donorForm').reset();
        }
        window.showHome = function() {
            document.getElementById('view-registration').style.display = 'none';
            document.getElementById('view-already-registered').style.display = 'none';
            document.getElementById('view-home').style.display = 'block';
            window.scrollTo(0, 0);
        }
        window.showToast = function(icon, msg, type) {
            const t = document.getElementById('toast-box');
            t.innerHTML = `<i class="${icon}"></i> ${msg}`;
            t.style.background = type === 'success' ? '#28a745' : '#ff4b2b';
            t.style.display = 'flex';
            setTimeout(() => t.style.display = 'none', 3000);
        }
        window.copyText = function(id) { 
            navigator.clipboard.writeText(document.getElementById(id).innerText); 
            window.showToast('fa-solid fa-check', 'কপি হয়েছে!', 'success'); 
        }

        // --- Navigation Logic ---
        window.nextStep = function(stepId) {
            const step = document.getElementById(stepId);
            if (step && !step.classList.contains('active')) {
                step.classList.add('active');
                setTimeout(() => step.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
            }
        }
        window.checkInput = function(input, next) { if(input.value.length > 2) window.nextStep(next); }
        window.checkMobileGroup = function() { if(document.getElementById('mobile').value.length >= 11) window.nextStep('step-address'); window.updateWhatsappList(); }
        window.checkAddressGroup = function() { if(document.getElementById('address').value.length > 3) window.nextStep('step-donation'); }
        window.checkDonationDate = function() { /* Optional Logic */ }
        window.checkAgeLogic = function() {
            const d = new Date(document.getElementById('dob').value);
            const diff = new Date() - d;
            const age = Math.floor(diff / (1000 * 60 * 60 * 24 * 365.25));
            if(age < 18) window.openModal('modal-underage'); else window.nextStep('step-gender');
        }
        window.updateWhatsappList = function() {
            const m=document.getElementById('mobile').value, am=document.getElementById('altMobile').value, w=document.getElementById('whatsappSelect');
            w.innerHTML='<option value="">বাছাই করুন</option>';
            if(m.length>5) {let o=document.createElement('option'); o.value=m; o.text='মোবাইল: '+m; w.add(o);}
            if(am.length>5) {let o=document.createElement('option'); o.value=am; o.text='বিকল্প: '+am; w.add(o);}
            let o=document.createElement('option'); o.value='custom'; o.text='লিখুন (অন্য নম্বর)'; w.add(o);
        }
        window.handleWhatsappLogic = function() {
            document.getElementById('whatsappCustom').style.display=(document.getElementById('whatsappSelect').value==='custom')?'block':'none';
            window.nextStep('step-agreement');
        }
        window.toggleSubmit = function() {
            document.getElementById('submitBtn').style.display = document.getElementById('agreePolicy').checked ? 'block' : 'none';
        }

        // --- FIREBASE SUBMISSION LOGIC ---
        document.getElementById('submitBtn').addEventListener('click', async function(e){
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            // UI Loading State
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> প্রসেসিং...';
            submitBtn.disabled = true;

            // Collect Data
            const mobileNum = document.getElementById('mobile').value;
            let formData = {
                fullName: document.getElementById('fullName').value,
                bloodGroup: document.getElementById('bloodGroup').value,
                dob: document.getElementById('dob').value,
                gender: document.getElementById('gender').value,
                mobile: mobileNum,
                altMobile: document.getElementById('altMobile').value || "N/A",
                district: document.getElementById('district').value,
                upazila: document.getElementById('upazila').value,
                address: document.getElementById('address').value,
                lastDonation: document.getElementById('lastDonation').value || "N/A",
                frequency: document.getElementById('frequency').value,
                whatsapp: document.getElementById('whatsappSelect').value === 'custom' ? document.getElementById('whatsappCustom').value : document.getElementById('whatsappSelect').value,
                facebook: document.getElementById('fbLink').value || "N/A",
                timestamp: new Date()
            };

            try {
                // 1. Check for Duplicates (Phone Number)
                const donorsRef = collection(db, "donors");
                const q = query(donorsRef, where("mobile", "==", mobileNum));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    window.showToast('fa-solid fa-triangle-exclamation', 'এই নম্বর দিয়ে ইতিমধ্যে রেজিস্ট্রেশন করা আছে!', 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }

                // 2. Generate Custom ID (Simple Random for now)
                const randomNum = Math.floor(1000 + Math.random() * 9000);
                const donorId = `RM-${randomNum}`;
                formData.donorId = donorId;

                // 3. Save to Firestore
                await addDoc(collection(db, "donors"), formData);

                // 4. Success Handling
                document.getElementById('success-id').innerText = donorId;
                window.openModal('modal-success');
                
                // Save locally
                const userData = {
                    name: formData.fullName, id: donorId, group: formData.bloodGroup
                };
                localStorage.setItem('roktomitro_donor', JSON.stringify(userData));
                
                document.getElementById('donorForm').reset();

            } catch (error) {
                console.error("Error adding document: ", error);
                window.showToast('fa-solid fa-triangle-exclamation', 'সার্ভারে সমস্যা হয়েছে! আবার চেষ্টা করুন।', 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Page Load Init
        window.addEventListener('load', function() {
            var ua = navigator.userAgent || navigator.vendor || window.opera;
            var isInApp = (ua.indexOf("FBAN") > -1) || (ua.indexOf("FBAV") > -1) || (ua.indexOf("Instagram") > -1) || (ua.indexOf("Messenger") > -1);

            if (isInApp) {
                document.getElementById('modal-fb-warning').style.display = 'flex';
            } else {
                const hasSeenPopup = localStorage.getItem('roktomitro_popup_seen');
                if (!hasSeenPopup) {
                    const popup = document.getElementById('popup-maintenance');
                    if(popup) {
                        popup.style.display = 'flex';
                        let timeLeft = 10;
                        const timerDisplay = document.getElementById('timer');
                        const countdown = setInterval(() => {
                            timeLeft--;
                            if(timerDisplay) timerDisplay.innerText = timeLeft;
                            if (timeLeft <= 0) {
                                clearInterval(countdown);
                                window.closePopupForever();
                            }
                        }, 1000);
                    }
                }
            }
            // Check Local Storage
            const savedUser = localStorage.getItem('roktomitro_donor');
            if (savedUser) {
                const user = JSON.parse(savedUser);
                document.getElementById('reg-name').innerText = user.name;
                document.getElementById('reg-id').innerText = user.id;
                document.getElementById('reg-group').innerText = user.group;
            }
        });

    </script>
</body>
</html>
