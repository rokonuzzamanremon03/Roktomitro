<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Roktomitro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #764ba2; --secondary: #667eea; --dark: #343a40; --light: #f8f9fa; --success: #28a745; --warning: #ffc107; --danger: #dc3545; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Hind Siliguri', sans-serif; }
        body { display: flex; background: #f0f2f5; height: 100vh; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 250px; background: var(--primary); color: white; display: flex; flex-direction: column; padding: 20px; }
        .brand { font-size: 1.8rem; font-weight: 800; margin-bottom: 40px; text-align: center; }
        .nav-item { padding: 15px; cursor: pointer; border-radius: 10px; margin-bottom: 10px; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.2); }
        .logout { margin-top: auto; background: var(--danger); }

        /* Main Content */
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* Dashboard Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center; }
        .stat-number { font-size: 2.5rem; font-weight: 800; color: var(--primary); }
        
        /* Charts Area */
        .charts-container { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 30px; }
        .chart-box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        /* Tables */
        .table-container { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: var(--light); color: var(--dark); white-space: nowrap; }
        .btn-sm { padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; color: white; }
        .btn-approve { background: var(--success); }
        .btn-reject { background: var(--danger); }

        /* Section Visibility */
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }

        /* Chat Layout */
        .chat-layout { display: flex; height: 70vh; gap: 20px; }
        .chat-users { width: 30%; background: white; border-radius: 15px; overflow-y: auto; }
        .chat-box { flex: 1; background: white; border-radius: 15px; display: flex; flex-direction: column; }
        .user-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .user-item:hover { background: #f8f9fa; }
        .messages-area { flex: 1; padding: 20px; overflow-y: auto; background: #f0f2f5; }
        .msg { padding: 8px 15px; border-radius: 20px; margin-bottom: 10px; max-width: 70%; font-size: 0.9rem; }
        .msg-user { background: white; align-self: flex-start; margin-right: auto; }
        .msg-admin { background: var(--secondary); color: white; margin-left: auto; display: block; width: fit-content; }
        .chat-input { padding: 15px; border-top: 1px solid #ddd; display: flex; gap: 10px; }

        /* Bulk Upload Styles */
        .upload-area { border: 2px dashed #ccc; padding: 40px; text-align: center; border-radius: 15px; background: white; cursor: pointer; transition: 0.3s; }
        .upload-area:hover { border-color: var(--primary); background: #f8f9fa; }
        #fileInput { display: none; }
        .progress-bar { width: 100%; background: #e0e0e0; height: 10px; border-radius: 5px; margin-top: 20px; overflow: hidden; display: none; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: 0.3s; }
    </style>
</head>
<body>

    <div id="admin-login" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--primary); z-index:9999; display:flex; justify-content:center; align-items:center;">
        <div style="background:white; padding:40px; border-radius:20px; text-align:center; width:350px;">
            <h2>এডমিন প্যানেল</h2>
            <input type="password" id="adminPass" placeholder="পাসওয়ার্ড দিন" style="width:100%; padding:10px; margin:20px 0; border:1px solid #ddd; border-radius:5px;">
            <button onclick="checkAdmin()" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:5px; cursor:pointer;">লগইন</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="brand"><i class="fa-solid fa-heart-pulse"></i> রক্তমিত্র</div>
        <div class="nav-item active" onclick="showSection('dash')"><i class="fa-solid fa-chart-line"></i> ড্যাশবোর্ড</div>
        <div class="nav-item" onclick="showSection('bulk')"><i class="fa-solid fa-file-csv"></i> বাল্ক আপলোড</div>
        <div class="nav-item" onclick="showSection('appeals')"><i class="fa-solid fa-user-pen"></i> তথ্য পরিবর্তন</div>
        <div class="nav-item" onclick="showSection('logs')"><i class="fa-solid fa-list-check"></i> কল রেজিস্ট্রি</div>
        <div class="nav-item" onclick="showSection('requests')"><i class="fa-solid fa-bed-pulse"></i> রক্তের আবেদন</div>
        <div class="nav-item" onclick="showSection('chat')"><i class="fa-solid fa-comments"></i> লাইভ চ্যাট</div>
        <div class="nav-item logout" onclick="location.reload()"><i class="fa-solid fa-right-from-bracket"></i> লগআউট</div>
    </div>

    <div class="main">
        
        <div id="dash" class="section active">
            <h2 class="header">ওভারভিউ (Live)</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <p>মোট ডোনার</p>
                    <div class="stat-number" id="total-donors">0</div>
                </div>
                <div class="stat-card">
                    <p>এই মাসে সেবা পেয়েছে</p>
                    <div class="stat-number" id="monthly-served">0</div>
                </div>
                <div class="stat-card">
                    <p>পেন্ডিং আপিল</p>
                    <div class="stat-number text-warning" id="pending-appeals" style="color:orange">0</div>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-box">
                    <h3 style="text-align:center; margin-bottom:15px;">ডোনার অনুপাত (Male/Female)</h3>
                    <canvas id="genderChart"></canvas>
                </div>
                <div class="chart-box">
                    <h3 style="margin-bottom:15px;">অ্যাক্টিভিটি লগ (Last 7 Days)</h3>
                    <div id="recent-activity-list" style="padding:10px;">Loading...</div>
                </div>
            </div>
        </div>

        <div id="bulk" class="section">
            <h2 class="header">বাল্ক ডোনার আপলোড (Excel/CSV)</h2>
            <div class="chart-box" style="margin-bottom: 20px;">
                <p style="margin-bottom: 15px; color: #666;">
                    <strong>নির্দেশনা:</strong> আপনার .xlsx বা .csv ফাইলটি আপলোড করুন। ফাইলটিতে অবশ্যই 
                    <code>Donor ID</code>, <code>Name</code>, <code>Blood Group</code>, <code>Mobile Number</code> কলামগুলো থাকতে হবে।
                </p>
                
                <label for="fileInput" class="upload-area">
                    <i class="fa-solid fa-cloud-arrow-up" style="font-size: 3rem; color: var(--secondary);"></i>
                    <h3 style="margin-top: 10px;">এখানে ক্লিক করে ফাইল সিলেক্ট করুন</h3>
                    <p id="fileNameDisplay">No file chosen</p>
                </label>
                <input type="file" id="fileInput" accept=".csv, .xlsx, .xls" onchange="handleFileSelect(event)">
                
                <div id="uploadControls" style="display: none; margin-top: 20px; text-align: center;">
                    <button class="btn-approve" onclick="processAndUpload()" style="padding: 12px 30px; font-size: 1.1rem;">
                        <i class="fa-solid fa-database"></i> ডাটাবেসে আপলোড করুন
                    </button>
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="uploadStatus" style="margin-top: 10px; font-weight: bold;"></p>
                </div>
            </div>

            <h3 class="header">প্রিভিউ (প্রথম ৫টি)</h3>
            <div class="table-container">
                <table id="previewTable">
                    <thead>
                        <tr><th>ID</th><th>Name</th><th>Group</th><th>Mobile</th><th>District</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" style="text-align:center">ফাইল সিলেক্ট করার পর প্রিভিউ দেখাবে</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="appeals" class="section">
            <h2 class="header">তথ্য পরিবর্তনের আবেদন</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ডোনার নাম</th>
                            <th>আইডি</th>
                            <th>কি পরিবর্তন চায়?</th>
                            <th>স্ট্যাটাস</th>
                            <th>অ্যাকশন</th>
                        </tr>
                    </thead>
                    <tbody id="appeal-table-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="logs" class="section">
            <h2 class="header">কল রেজিস্ট্রি</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>সময়</th>
                            <th>খুঁজছে (Seeker)</th>
                            <th>ডোনার (Donor)</th>
                            <th>মাধ্যম</th>
                        </tr>
                    </thead>
                    <tbody id="logs-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="requests" class="section">
            <h2 class="header">রক্তের আবেদনসমূহ</h2>
            <div class="table-container">
                <table id="req-table">
                    <thead>
                        <tr><th>তারিখ</th><th>রোগী</th><th>গ্রুপ</th><th>স্থান</th><th>মোবাইল</th></tr>
                    </thead>
                    <tbody id="req-table-body">
                         <tr><td colspan="5" style="text-align:center">লোডিং...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="chat" class="section">
            <h2 class="header">লাইভ সাপোর্ট</h2>
            <div class="chat-layout">
                <div class="chat-users" id="chat-user-list">
                    </div>
                <div class="chat-box">
                    <div id="active-chat-header" style="padding:15px; border-bottom:1px solid #eee; font-weight:bold;">Select a user</div>
                    <div class="messages-area" id="admin-chat-msgs"></div>
                    <div class="chat-input">
                        <input type="text" id="admin-msg-input" placeholder="মেসেজ লিখুন..." style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd;">
                        <button class="btn-approve" onclick="sendAdminMsg()">Send</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, query, where, onSnapshot, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhiWE13tazdBO8uKdFAK7obuMrHRyK4PE",
            authDomain: "roktomitro-6e5d3.firebaseapp.com",
            projectId: "roktomitro-6e5d3",
            storageBucket: "roktomitro-6e5d3.firebasestorage.app",
            messagingSenderId: "1089255935970",
            appId: "1:1089255935970:web:ceb2feaab1b5096878f3bb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- ADMIN AUTH ---
        window.checkAdmin = function() {
            const p = document.getElementById('adminPass').value;
            if(p === "admin1234") { 
                document.getElementById('admin-login').style.display = 'none';
                loadDashboard();
                listenAppeals();
                loadLogs();
                loadRequests();
                listenChats();
            } else {
                alert("ভুল পাসওয়ার্ড!");
            }
        }

        // --- NAVIGATION ---
        window.showSection = function(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // --- 1. DASHBOARD LOGIC ---
        async function loadDashboard() {
            const q = query(collection(db, "donors"));
            const snapshot = await getDocs(q);
            const total = snapshot.size;
            let male = 0, female = 0;
            
            snapshot.forEach(doc => {
                const d = doc.data();
                if(d.gender === "Male" || d.gender === "পুরুষ") male++;
                else female++;
            });

            document.getElementById('total-donors').innerText = total;

            if(window.myChart) window.myChart.destroy();
            const ctx = document.getElementById('genderChart').getContext('2d');
            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['পুরুষ', 'মহিলা'],
                    datasets: [{
                        data: [male, female],
                        backgroundColor: ['#667eea', '#ff416c']
                    }]
                }
            });
            document.getElementById('monthly-served').innerText = "Generating..."; 
        }

        // --- 2. BULK UPLOAD LOGIC (NEW FEATURE) ---
        let excelData = [];

        window.handleFileSelect = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('fileNameDisplay').innerText = file.name;
            const reader = new FileReader();

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheet];
                
                // Convert to JSON
                const rawData = XLSX.utils.sheet_to_json(worksheet);
                excelData = rawData; // Store for upload
                
                showPreview(rawData);
                document.getElementById('uploadControls').style.display = 'block';
            };
            reader.readAsArrayBuffer(file);
        }

        function showPreview(data) {
            const tbody = document.querySelector('#previewTable tbody');
            tbody.innerHTML = "";
            // Show first 5 rows
            data.slice(0, 5).forEach(row => {
                const tr = document.createElement('tr');
                // Mapping according to your XLSX columns
                tr.innerHTML = `
                    <td>${row['Donor ID'] || 'N/A'}</td>
                    <td>${row['Name'] || 'N/A'}</td>
                    <td>${row['Blood Group'] || 'N/A'}</td>
                    <td>${row['Mobile Number'] || 'N/A'}</td>
                    <td>${row['District'] || 'N/A'}</td>
                    <td>Ready</td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.processAndUpload = async function() {
            if(excelData.length === 0) return alert("No data found!");
            
            const btn = document.querySelector('#uploadControls button');
            btn.disabled = true;
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const statusText = document.getElementById('uploadStatus');
            
            progressBar.style.display = 'block';
            let successCount = 0;
            let errorCount = 0;

            for(let i=0; i<excelData.length; i++) {
                const row = excelData[i];
                
                // DATA MAPPING: Excel Column -> Firebase Field
                const donorId = row['Donor ID'] ? String(row['Donor ID']) : `RM-${Math.floor(1000 + Math.random() * 9000)}`;
                
                const donorData = {
                    donorId: donorId,
                    fullName: row['Name'] || "Unknown",
                    bloodGroup: row['Blood Group'] || "N/A",
                    mobile: row['Mobile Number'] ? String(row['Mobile Number']) : "N/A",
                    altMobile: row['Alt Mobile Number'] ? String(row['Alt Mobile Number']) : "N/A",
                    district: row['District'] || "Satkhira",
                    upazila: row['Upazila'] || "N/A",
                    address: row['Address'] || "N/A",
                    gender: row['Gender'] || "N/A",
                    dob: "N/A", // Excel এ Age আছে, DOB নেই, তাই N/A
                    lastDonation: row['Last Donation (Days Ago)'] || "N/A",
                    whatsapp: row['Whatsapp'] ? String(row['Whatsapp']) : "N/A",
                    fbLink: row['Facebook'] || "N/A",
                    isActive: true,
                    importedAt: serverTimestamp()
                };

                try {
                    // Use setDoc to create or overwrite based on ID
                    await setDoc(doc(db, "donors", donorId), donorData);
                    successCount++;
                } catch(e) {
                    console.error("Error importing row", i, e);
                    errorCount++;
                }

                // Update Progress
                const pct = Math.round(((i + 1) / excelData.length) * 100);
                progressFill.style.width = pct + "%";
                statusText.innerText = `Uploading: ${i+1}/${excelData.length}`;
            }

            statusText.innerText = `Complete! Success: ${successCount}, Failed: ${errorCount}`;
            btn.disabled = false;
            alert("Upload Completed!");
            loadDashboard(); // Refresh stats
        }

        // --- 3. APPEALS SYSTEM ---
        function listenAppeals() {
            const q = query(collection(db, "appeals"), where("status", "==", "pending"));
            onSnapshot(q, (snapshot) => {
                document.getElementById('pending-appeals').innerText = snapshot.size;
                const tbody = document.getElementById('appeal-table-body');
                tbody.innerHTML = "";
                
                snapshot.forEach(d => {
                    const data = d.data();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${data.userName}</td>
                        <td>${data.donorId}</td>
                        <td>${data.requestText}</td>
                        <td><span style="background:orange; padding:2px 8px; border-radius:10px; font-size:0.8rem;">Pending</span></td>
                        <td>
                            <button class="btn-sm btn-approve" onclick="window.processAppeal('${d.id}', '${data.donorId}', true)">Approve</button>
                            <button class="btn-sm btn-reject" onclick="window.processAppeal('${d.id}', '${data.donorId}', false)">Reject</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        window.processAppeal = async function(appealId, donorId, isApproved) {
            if(!confirm("Are you sure?")) return;
            try {
                await updateDoc(doc(db, "appeals", appealId), {
                    status: isApproved ? "approved" : "rejected"
                });
                alert("Action Processed!");
            } catch(e) { console.error(e); alert("Error!"); }
        }

        // --- 4. CALL LOGS ---
        function loadLogs() {
            const q = query(collection(db, "contact_logs"), orderBy("time", "desc"));
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('logs-table-body');
                tbody.innerHTML = "";
                let count = 0;
                
                snapshot.forEach(d => {
                    const data = d.data();
                    count++;
                    const date = data.time ? new Date(data.time.seconds * 1000).toLocaleString() : "N/A";
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${date}</td>
                        <td>${data.seeker}</td>
                        <td>${data.donor}</td>
                        <td>${data.type}</td>
                    `;
                    tbody.appendChild(tr);
                });
                document.getElementById('monthly-served').innerText = count;
            });
        }

        // --- 5. REQUESTS ---
        async function loadRequests() {
             const q = query(collection(db, "blood_requests"), orderBy("postedAt", "desc"));
             const snap = await getDocs(q);
             const tbody = document.getElementById('req-table-body');
             tbody.innerHTML = "";
             snap.forEach(d => {
                 const data = d.data();
                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                    <td>${new Date(data.postedAt.seconds*1000).toLocaleDateString()}</td>
                    <td>${data.name}</td>
                    <td>${data.group}</td>
                    <td>${data.location}</td>
                    <td>${data.mobile}</td>
                 `;
                 tbody.appendChild(tr);
             });
        }

        // --- 6. CHAT SYSTEM ---
        let activeChatUser = null;

        function listenChats() {
            const q = query(collection(db, "chats")); 
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('chat-user-list');
                list.innerHTML = "";
                
                snapshot.forEach(d => {
                    const div = document.createElement('div');
                    div.className = 'user-item';
                    div.innerText = d.id; 
                    div.onclick = () => loadChatMessages(d.id);
                    list.appendChild(div);
                });
            });
        }

        function loadChatMessages(userId) {
            activeChatUser = userId;
            document.getElementById('active-chat-header').innerText = "Chat with: " + userId;
            const chatArea = document.getElementById('admin-chat-msgs');
            
            const q = query(collection(db, "chats", userId, "messages"), orderBy("createdAt"));
            onSnapshot(q, (snapshot) => {
                chatArea.innerHTML = "";
                snapshot.forEach(d => {
                    const msg = d.data();
                    const div = document.createElement('div');
                    div.className = `msg ${msg.sender === 'admin' ? 'msg-admin' : 'msg-user'}`;
                    div.innerText = msg.text;
                    chatArea.appendChild(div);
                });
                chatArea.scrollTop = chatArea.scrollHeight;
            });
        }

        window.sendAdminMsg = async function() {
            const txt = document.getElementById('admin-msg-input').value;
            if(!txt || !activeChatUser) return;

            await addDoc(collection(db, "chats", activeChatUser, "messages"), {
                text: txt,
                sender: 'admin',
                createdAt: serverTimestamp()
            });
            document.getElementById('admin-msg-input').value = "";
        }

    </script>
</body>
</html>